
# Do we need an extra rank for the MUST debugger?

include ./MkFlags
WITH_MUST=no
ifeq ($(WITH_MUST), yes)
	COMMS_FLAGS += -DWITH_MUST
endif


ifeq ($(MPI), yes)
	MPI_RUNNER = mpirun --oversubscribe -n $$(($(NP_X) * $(NP_Y) * $(NP_T) * $(NP_THIRD)))
else
	COMMS_LIB = uncomms.o
	MPI_RUNNER =
endif



TESTS = test_dslash_1 

default: $(TESTS)
tests: $(TESTS)

runtests: $(TESTS)
	@for test in $(TESTS); do \
	    printf "$$test: "; \
	    OUTPUT=$$($(MPI_RUNNER) ./$$test) && \
	    if [ -z "$$OUTPUT" ]; then \
	        echo "OK"; \
	    else \
	        echo; \
	        echo "$$OUTPUT"; \
	    fi; \
	done
	@for test in $(TESTS_TO_FAIL); do \
	    printf "$$test: "; \
		if ./$$test >/dev/null ; then \
		    echo "Program should have failed and it did not."; \
	    else \
		    echo "OK";\
	    fi; \
	done




clean:
	rm -f $(TESTS) *.mod *.o compile_flags

.makefile.uptodate: Makefile ../MkRules ./MkFlags
	make clean
	touch .makefile.uptodate

params.o : test_params.F90 .makefile.uptodate
	$(FC) $(FCFLAGS) $(COMMS_FLAGS) $(RANDOM_FLAGS) -c -o params.o $<

test_utils.o : test_utils.F90 .makefile.uptodate comms.mod params.mod random.mod
	$(FC) $(FCFLAGS) $(COMMS_FLAGS) $(RANDOM_FLAGS) -c -o test_utils.o $<


TOPDIR = ..

include ../MkRules

LIBOBJS += test_utils.o

MODS=$(patsubst %.o,%.mod,$(LIBOBJS))

.PRECIOUS : %.mod



test_%.o: test_%.F90 .makefile.uptodate test_utils.F90 test_utils.fh $(MODS)
	$(FC) $(FCFLAGS) $(COMMS_FLAGS) $(RANDOM_FLAGS) -c -o $@ $<

$(TESTS) : % : %.o $(LIBOBJS)
	$(FC) $(FCFLAGS) $(COMMS_FLAGS) $(RANDOM_FLAGS) -o $@ $^
